name: Auto Merge Branch-A to Branch-B and Notify

on:
  push:
    branches:
      - main

permissions:
  contents: write
  issues: write

jobs:
  merge-and-notify:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout the repository
      uses: actions/checkout@v4

    - name: Configure Git user
      run: |
        git config user.name "Github-CI-rotbot"
        git config user.email "dipengxu@163.com"

    - name: Fetch all branches
      run: git fetch --all

    - name: Checkout Branch-B
      run: git checkout Branch-B

    - name: Merge main into Branch-B
      id: merge
      run: |
        {
          if git merge origin/main -m "Auto-merge main into Branch-B"; then
            echo "MERGE_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "MERGE_SUCCESS=false" >> $GITHUB_ENV
          fi
        } 2>&1 | tee merge_log.txt

    - name: Push changes if merge succeeded
      if: env.MERGE_SUCCESS == 'true'
      run: git push origin Branch-B

    - name: Read merge log
      id: readlog
      run: |
        LOG_CONTENT=$(cat merge_log.txt | base64)
        echo "LOG_CONTENT=$LOG_CONTENT" >> $GITHUB_ENV

    - name: Create GitHub Issue on Merge Failure
      if: env.MERGE_SUCCESS == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: issue } = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: "⚠️ main 自动合并 Branch-B 失败了",
            body: `
              自动合并 main 到 Branch-B 失败了，请手动处理冲突！

              合并日志：
              ----------------
              ${{ env.LOG_CONTENT }}
            `,
            labels: ["merge-failed"]
          });
